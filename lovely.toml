[manifest]
version = "1.0"
dump_lua = true
priority = 5

# Fast Save Loader mod for Balatro.
# Folder layout:
# FastSaveLoaderMod/
#     lovely.toml
#     Core/
#       Init.lua
#       SaveManager.lua
#       StateSignature.lua
#       GamePatches.lua
#     Utils/
#       Utils.lua
#       EntryConstants.lua
#       MetaFile.lua
#       FileIO.lua
#       ActionDetector.lua
#       CacheManager.lua
#       Pruning.lua
#       DuplicateDetector.lua
#     UI/
#       LoaderUI.lua
#       ButtonCallbacks.lua
#     Keybinds.lua
#     main.lua (Steamodded config)

[[patches]]
[patches.copy]
target = "globals.lua"
position = "append"
sources = [ "Core/Init.lua" ]

[[patches]]
[patches.copy]
target = "main.lua"
position = "append"
sources = [ "Keybinds.lua" ]

[[patches]]
[patches.copy]
target = "functions/UI_definitions.lua"
position = "append"
sources = [ "UI/LoaderUI.lua" ]

[[patches]]
[patches.copy]
target = "functions/button_callbacks.lua"
position = "append"
sources = [ "UI/ButtonCallbacks.lua" ]

[[patches]]
[patches.regex]
target = "functions/button_callbacks.lua"
pattern = "func = function\\(\\)\\n      delay\\(0.1\\)"
position = "at"
payload = """func = function()
      if not G.screenwipe or not G.screenwipe.children or not G.screenwipe.children.particles then return true end
      delay(0.1)"""
match_indent = true

[[patches]]
[patches.regex]
target = "functions/button_callbacks.lua"
pattern = "func = function\\(\\)\\n      if G.screenwipecard then"
position = "at"
payload = """func = function()
      if not G.screenwipe then return true end
      if G.screenwipecard then"""
match_indent = true

[[patches]]
[patches.regex]
target = "functions/button_callbacks.lua"
pattern = "func = function\\(\\)\\n      G.screenwipe.children.particles:remove\\(\\)"
position = "at"
payload = """func = function()
      if not G.screenwipe or not G.screenwipe.children or not G.screenwipe.children.particles then return true end
      G.screenwipe.children.particles:remove()"""
match_indent = true

[[patches]]
[patches.copy] # GamePatches is not a module; it's a set of global overrides.
target = "globals.lua"
position = "append"
sources = [ "Core/GamePatches.lua" ] # Appended after Init.lua (which is also appended to globals.lua)


[[patches]]
[patches.module]
name = "Utils"
source = "Utils/Utils.lua"
load_now = true
before = "globals.lua"

[[patches]]
[patches.module]
name = "EntryConstants"
source = "Utils/EntryConstants.lua"
load_now = true
before = "globals.lua"

[[patches]]
[patches.module]
name = "MetaFile"
source = "Utils/MetaFile.lua"
load_now = true
before = "globals.lua"

[[patches]]
[patches.module]
name = "FileIO"
source = "Utils/FileIO.lua"
load_now = true
before = "globals.lua"

[[patches]]
[patches.module]
name = "ActionDetector"
source = "Utils/ActionDetector.lua"
load_now = true
before = "globals.lua"

[[patches]]
[patches.module]
name = "CacheManager"
source = "Utils/CacheManager.lua"
load_now = true
before = "globals.lua"

[[patches]]
[patches.module]
name = "Pruning"
source = "Utils/Pruning.lua"
load_now = true
before = "globals.lua"

[[patches]]
[patches.module]
name = "DuplicateDetector"
source = "Utils/DuplicateDetector.lua"
load_now = true
before = "globals.lua"

[[patches]]
[patches.module]
name = "StateSignature"
source = "Core/StateSignature.lua"
load_now = true # Load immediately so Init.lua can require it
before = "globals.lua"

[[patches]]
[patches.module]
name = "SaveManager"
source = "Core/SaveManager.lua"
load_now = true # Load immediately so Init.lua can require it
before = "globals.lua"

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "function Card:open()"
position = "after"
match_indent = true
payload = "if LOADER and LOADER._SaveManager then LOADER._SaveManager.skipping_pack_open = true end"

[[patches]]
[patches.regex]
target = "functions/misc_functions.lua"
pattern = "G.ARGS.save_run = G.culled_table"
position = "after"
match_indent = true
payload = """
   if LOADER and LOADER.defer_save_creation then
      LOADER.defer_save_creation()
   end"""
